<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D å¤ªé˜³ç³»ï¼šæ‰‹åŠ¿æ§åˆ¶ä¿®å¤ç‰ˆ</title>
    
    <!-- å¼•å…¥ MediaPipe åº“ (ä½¿ç”¨æ›´ç¨³å®šçš„ CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: "Microsoft YaHei", sans-serif; }
        #canvas-container { width: 100vw; height: 100vh; display: block; }

        /* --- æ‘„åƒå¤´é¢„è§ˆ HUD (ä¿®å¤æ ·å¼) --- */
        .camera-hud {
            position: fixed; bottom: 20px; right: 20px; width: 220px; height: 165px;
            background: rgba(0,0,0,0.8); border: 2px solid #00ffcc; border-radius: 10px;
            overflow: hidden; z-index: 200; display: none; transform: scaleX(-1);
            box-shadow: 0 0 20px rgba(0, 255, 204, 0.3);
        }
        .camera-video { position: absolute; width: 100%; height: 100%; object-fit: cover; opacity: 0.6; }
        .camera-canvas { position: absolute; width: 100%; height: 100%; top:0; left:0; }

        /* --- æ§åˆ¶å¼€å…³ --- */
        .camera-toggle {
            position: fixed; top: 20px; right: 20px;
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white; border: none; padding: 12px 24px; border-radius: 30px;
            font-size: 1rem; cursor: pointer; z-index: 201;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            transition: transform 0.2s; font-weight: bold;
        }
        .camera-toggle:active { transform: scale(0.95); }
        .camera-toggle.active { background: linear-gradient(135deg, #ff4500, #c72c00); }

        /* --- çŠ¶æ€æç¤ºæ–‡å­— --- */
        .gesture-status {
            position: fixed; top: 80px; right: 20px;
            color: #fff; font-size: 1.1rem; font-weight: bold;
            text-shadow: 0 2px 4px black; z-index: 200;
            background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 5px;
            text-align: right; pointer-events: none;
        }

        /* --- ä¿¡æ¯é¢æ¿æ ·å¼ --- */
        .info-panel {
            position: fixed; bottom: 20px; left: 20px; width: 360px; max-width: 90vw;
            background: rgba(30, 35, 50, 0.95); backdrop-filter: blur(15px);
            border-radius: 16px; border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 20px; color: white; z-index: 100; transition: 0.3s;
            max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }
        
        /* ä¿®å¤ï¼šå¯¼èˆªå›¾æ ‡æ ·å¼è°ƒæ•´ï¼Œå¢å¼ºå¯è§æ€§ */
        .nav-bar { display: flex; gap: 12px; overflow-x: auto; margin-bottom: 15px; padding-bottom: 5px; }
        .nav-icon {
            width: 45px; height: 45px; border-radius: 50%; flex-shrink: 0; cursor: pointer;
            background-size: cover; background-position: center;
            /* å…³é”®ä¿®æ”¹ï¼šå¢åŠ ç™½è‰²è¾¹æ¡†å’ŒåŠé€æ˜èƒŒæ™¯ï¼Œé˜²æ­¢å›¾æ ‡çœ‹ä¸æ¸… */
            border: 2px solid rgba(255, 255, 255, 0.6);
            background-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            transition: all 0.2s;
        }
        .nav-icon:hover { transform: scale(1.1); border-color: #fff; }
        .nav-icon.active {
            border-color: #ffd700; /* é€‰ä¸­æ—¶é‡‘è‰²è¾¹æ¡† */
            transform: scale(1.2);
            box-shadow: 0 0 15px #ffd700; /* é€‰ä¸­æ—¶å‘å…‰ */
        }

        h2 { margin: 0; color: #ffd700; font-size: 1.8rem; }
        .real-photo { width: 100%; height: 180px; object-fit: cover; border-radius: 8px; margin: 15px 0; border: 1px solid rgba(255,255,255,0.2); }
        .speak-btn { background: linear-gradient(90deg, #ff8c00, #ff4500); color: white; border: none; padding: 12px; width: 100%; border-radius: 25px; cursor: pointer; margin-top: 10px; font-weight: bold; font-size: 1rem; }

        #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 1.5rem; pointer-events: none; z-index: 999; background: rgba(0,0,0,0.7); padding: 20px; border-radius: 10px;}
        
        /* é”™è¯¯æç¤ºå¼¹çª— */
        #errorMsg {
            display: none; position: fixed; top: 10%; left: 50%; transform: translateX(-50%);
            background: rgba(255, 0, 0, 0.9); color: white; padding: 15px 30px;
            border-radius: 8px; z-index: 1000; text-align: center; max-width: 80%;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

    <div id="loading">ğŸš€ ç³»ç»Ÿæ­£åœ¨åŠ è½½èµ„æº...</div>
    <div id="errorMsg"></div>
    <div id="canvas-container"></div>

    <!-- æ‘„åƒå¤´æ§åˆ¶ä¸æ˜¾ç¤º -->
    <button class="camera-toggle" id="camBtn">ğŸ“· å¼€å¯æ‰‹åŠ¿æ§åˆ¶</button>
    <div class="gesture-status" id="gestureStatus">ç­‰å¾…å¯åŠ¨...</div>

    <div class="camera-hud" id="cameraHud">
        <video class="camera-video"></video>
        <canvas class="camera-canvas"></canvas>
    </div>

    <!-- ä¿¡æ¯é¢æ¿ -->
    <div class="info-panel" id="infoPanel">
        <h2 id="planetName">å¤ªé˜³ç³»</h2>
        <div class="content-area">
            <div class="nav-bar" id="navBar">
                <!-- å›¾æ ‡ç”± JS ç”Ÿæˆ -->
            </div>
            <img id="planetPhoto" class="real-photo" src="" alt="">
            <p id="planetDesc" style="font-size:1rem; line-height:1.6; color:#eee;">
                ç‚¹å‡»å³ä¸Šè§’æŒ‰é’®å¼€å¯æ‰‹åŠ¿é­”æ³•ï¼<br>
                ğŸ–ï¸ <b>å¼ å¼€æ‰‹æŒ</b> = å‘å‰é£ (æ”¾å¤§)<br>
                âœŠ <b>æ¡ç´§æ‹³å¤´</b> = å‘åé€€ (ç¼©å°)<br>
                ğŸ‘‹ <b>æ‰‹åœ¨å±å¹•è¾¹ç¼˜</b> = æ—‹è½¬è§†è§’
            </p>
            <button class="speak-btn" id="speakBtn">ğŸ”Š å¬å¬ä»‹ç»</button>
        </div>
    </div>

    <script>
        // --- 1. Three.js åœºæ™¯æ„å»º (ä¿æŒä¸å˜) ---
        const planetData = [
            { key: 'mercury', name: 'æ°´æ˜Ÿ', size: 1, distance: 20, speed: 0.04, color: 0xA5A5A5, texture: 'https://upload.wikimedia.org/wikipedia/commons/3/30/Mercury_mostly_true_color_MESSENGER_orthographic_projection.jpg', photo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/d/d9/Mercury_in_color_-_Prockter07-edit1.jpg/600px-Mercury_in_color_-_Prockter07-edit1.jpg', desc: 'æˆ‘æ˜¯æ°´æ˜Ÿï¼Œå¤ªé˜³ç³»æœ€å°çš„è¡Œæ˜Ÿï¼Œè·‘å¾—æœ€å¿«ï¼' },
            { key: 'venus', name: 'é‡‘æ˜Ÿ', size: 1.8, distance: 28, speed: 0.015, color: 0xE3BB76, texture: 'https://upload.wikimedia.org/wikipedia/commons/1/1c/Solarsystemscope_texture_2k_venus_surface.jpg', photo: 'https://upload.wikimedia.org/wikipedia/commons/e/e5/Venus-real_color.jpg', desc: 'æˆ‘æ˜¯é‡‘æ˜Ÿï¼Œæœ€äº®çš„æ˜Ÿï¼Œæ¯”æ°´æ˜Ÿè¿˜çƒ­å“¦ï¼' },
            { key: 'earth', name: 'åœ°çƒ', size: 1.9, distance: 38, speed: 0.01, color: 0x22A6B3, texture: 'https://upload.wikimedia.org/wikipedia/commons/c/cf/Solarsystemscope_texture_2k_earth_daymap.jpg', photo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/97/The_Earth_seen_from_Apollo_17.jpg/600px-The_Earth_seen_from_Apollo_17.jpg', desc: 'æˆ‘æ˜¯åœ°çƒï¼Œè“è‰²çš„å®¶å›­ï¼Œå¤ªé˜³ç³»å”¯ä¸€æœ‰ç”Ÿå‘½çš„åœ°æ–¹ã€‚' },
            { key: 'mars', name: 'ç«æ˜Ÿ', size: 1.2, distance: 50, speed: 0.008, color: 0xDD4C22, texture: 'https://upload.wikimedia.org/wikipedia/commons/7/70/Solarsystemscope_texture_2k_mars.jpg', photo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/0/02/OSIRIS_Mars_true_color.jpg/600px-OSIRIS_Mars_true_color.jpg', desc: 'æˆ‘æ˜¯ç«æ˜Ÿï¼Œçº¢è‰²çš„æ²™æ¼ ï¼Œæœ‰æœ€é«˜çš„ç«å±±ã€‚' },
            { key: 'jupiter', name: 'æœ¨æ˜Ÿ', size: 5.5, distance: 75, speed: 0.004, color: 0xD8CA9D, texture: 'https://upload.wikimedia.org/wikipedia/commons/e/e4/Jupiter_Hubble_2019_Select.jpg', photo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/2/2b/Jupiter_and_its_shrunken_Great_Red_Spot.jpg/600px-Jupiter_and_its_shrunken_Great_Red_Spot.jpg', desc: 'æˆ‘æ˜¯æœ¨æ˜Ÿï¼Œä¸ªå¤´æœ€å¤§ï¼Œè‚šå­ä¸Šæœ‰ä¸ªå¤§çº¢æ–‘é£æš´ã€‚' },
            { key: 'saturn', name: 'åœŸæ˜Ÿ', size: 4.5, distance: 100, speed: 0.003, color: 0xF4D03F, hasRing: true, texture: 'https://upload.wikimedia.org/wikipedia/commons/0/03/Solarsystemscope_texture_2k_saturn.jpg', photo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/c/c7/Saturn_during_Equinox.jpg/640px-Saturn_during_Equinox.jpg', desc: 'æˆ‘æ˜¯åœŸæ˜Ÿï¼Œæˆ‘æœ‰æœ€æ¼‚äº®çš„å…‰ç¯ï¼Œèƒ½æµ®åœ¨æ°´é¢ä¸Šï¼' },
            { key: 'uranus', name: 'å¤©ç‹æ˜Ÿ', size: 3.0, distance: 125, speed: 0.002, color: 0x73C6B6, texture: 'https://upload.wikimedia.org/wikipedia/commons/9/95/Solarsystemscope_texture_2k_uranus.jpg', photo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/3/3d/Uranus2.jpg/600px-Uranus2.jpg', desc: 'æˆ‘æ˜¯å¤©ç‹æ˜Ÿï¼Œæˆ‘æ˜¯èººç€è½¬åœˆçš„å†°çƒã€‚' },
            { key: 'neptune', name: 'æµ·ç‹æ˜Ÿ', size: 2.9, distance: 150, speed: 0.001, color: 0x5B5DDF, texture: 'https://upload.wikimedia.org/wikipedia/commons/1/1e/Solarsystemscope_texture_2k_neptune.jpg', photo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/6/63/Neptune_-_Voyager_2_%2829347980845%29_flatten_crop.jpg/600px-Neptune_-_Voyager_2_%2829347980845%29_flatten_crop.jpg', desc: 'æˆ‘æ˜¯æµ·ç‹æ˜Ÿï¼Œç¦»å¾—æœ€è¿œï¼Œé£é€Ÿè¶…çº§å¿«ã€‚' }
        ];

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 80, 140);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.enableZoom = true;
        controls.maxDistance = 350;

        scene.add(new THREE.AmbientLight(0xaaaaaa, 0.8));
        scene.add(new THREE.PointLight(0xffffff, 1.2, 400));
        
        // ç”Ÿæˆæ˜Ÿç©º
        const starGeo = new THREE.BufferGeometry();
        const starPos = new Float32Array(6000 * 3);
        for(let i=0; i<6000*3; i++) starPos[i] = (Math.random() - 0.5) * 800;
        starGeo.setAttribute('position', new THREE.BufferAttribute(starPos, 3));
        scene.add(new THREE.Points(starGeo, new THREE.PointsMaterial({color: 0xffffff, size: 0.7})));

        const loader = new THREE.TextureLoader();
        const planetMeshes = [];

        // å¤ªé˜³
        scene.add(new THREE.Mesh(new THREE.SphereGeometry(10, 32, 32), new THREE.MeshBasicMaterial({map: loader.load('https://upload.wikimedia.org/wikipedia/commons/9/99/Map_of_the_full_sun.jpg'), color: 0xffdd00})));
        scene.add(new THREE.Mesh(new THREE.SphereGeometry(11, 32, 32), new THREE.MeshBasicMaterial({color: 0xffaa00, transparent: true, opacity: 0.3, side: THREE.BackSide})));

        // è¡Œæ˜Ÿ
        planetData.forEach(p => {
            const orbit = new THREE.Mesh(new THREE.RingGeometry(p.distance - 0.3, p.distance + 0.3, 128), new THREE.MeshBasicMaterial({color: p.color, opacity: 0.3, transparent: true, side: THREE.DoubleSide}));
            orbit.rotation.x = -Math.PI / 2;
            scene.add(orbit);
            const mesh = new THREE.Mesh(new THREE.SphereGeometry(p.size, 32, 32), new THREE.MeshStandardMaterial({map: loader.load(p.texture), color: 0xffffff, emissive: p.color, emissiveIntensity: 0.25}));
            const angle = Math.random() * Math.PI * 2;
            mesh.position.set(Math.cos(angle) * p.distance, 0, Math.sin(angle) * p.distance);
            scene.add(mesh);
            if(p.hasRing) {
                const ring = new THREE.Mesh(new THREE.RingGeometry(p.size * 1.4, p.size * 2.2, 64), new THREE.MeshBasicMaterial({map: loader.load('https://upload.wikimedia.org/wikipedia/commons/thumb/b/b1/Saturn_ring_texture.jpg/220px-Saturn_ring_texture.jpg'), side: THREE.DoubleSide, transparent: true, opacity: 0.8}));
                ring.rotation.x = -Math.PI / 2; mesh.add(ring);
            }
            planetMeshes.push({mesh, data: p, angle, distance: p.distance, speed: p.speed});
        });

        document.getElementById('loading').style.display = 'none';

        // --- 2. æ‰‹åŠ¿æ§åˆ¶æ ¸å¿ƒä»£ç  (ä¼˜åŒ–ç‰ˆ) ---
        const videoElement = document.querySelector('.camera-video');
        const canvasElement = document.querySelector('.camera-canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const gestureStatus = document.getElementById('gestureStatus');
        const errorMsg = document.getElementById('errorMsg');
        
        let cameraRunning = false;
        let myHands = null;
        let myCamera = null;

        // åˆå§‹åŒ– MediaPipe Hands
        function initHands() {
            if (myHands) return;
            try {
                myHands = new Hands({locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                }});
                myHands.setOptions({
                    maxNumHands: 1,
                    modelComplexity: 1,
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });
                myHands.onResults(onResults);
            } catch (e) {
                showError("ç»„ä»¶åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ");
            }
        }

        // æ‰‹åŠ¿å¸§å¤„ç†
        function onResults(results) {
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
            
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 2});
                drawLandmarks(canvasCtx, landmarks, {color: '#FF0000', lineWidth: 1});

                // --- æ–°ç‰ˆç®—æ³•ï¼šæ•°æ‰‹æŒ‡ ---
                // åˆ¤æ–­æ‰‹æŒ‡ä¼¸å‡ºï¼šæŒ‡å°–(Tip)çš„ y åæ ‡ å°äº å…³èŠ‚(Pip)çš„ y åæ ‡ (æ³¨æ„ï¼šå±å¹•åæ ‡ç³» y å‘ä¸‹å¢å¤§)
                // æ‹‡æŒ‡åˆ¤æ–­é€»è¾‘ä¸åŒï¼ˆçœ‹ x åæ ‡ï¼‰
                const fingers = [];
                // æ‹‡æŒ‡ (ç®€åŒ–åˆ¤æ–­ï¼Œæš‚ä¸è®¡å…¥æ§åˆ¶ï¼Œåªçœ‹é£ŸæŒ‡åˆ°å°æŒ‡)
                
                // æ£€æŸ¥é£ŸæŒ‡(8)ã€ä¸­æŒ‡(12)ã€æ— åæŒ‡(16)ã€å°æŒ‡(20) æ˜¯å¦ä¼¸ç›´
                // 8TIP < 6PIP (ä¼¸ç›´)
                const isIndexOpen = landmarks[8].y < landmarks[6].y;
                const isMiddleOpen = landmarks[12].y < landmarks[10].y;
                const isRingOpen = landmarks[16].y < landmarks[14].y;
                const isPinkyOpen = landmarks[20].y < landmarks[18].y;

                let openCount = 0;
                if(isIndexOpen) openCount++;
                if(isMiddleOpen) openCount++;
                if(isRingOpen) openCount++;
                if(isPinkyOpen) openCount++;

                // ç®—æ³•åˆ¤æ–­
                let isFist = openCount <= 1; // åªæœ‰0æˆ–1æ ¹æ‰‹æŒ‡ä¼¸ç›´ç®—æ‹³å¤´
                let isOpen = openCount >= 3; // 3æ ¹ä»¥ä¸Šç®—å¼ å¼€

                const palmX = landmarks[9].x; // æ‰‹æŒä¸­å¿ƒ X (0-1)
                const palmY = landmarks[9].y; // æ‰‹æŒä¸­å¿ƒ Y (0-1)

                updateControl(isFist, isOpen, palmX, palmY);
            } else {
                gestureStatus.innerText = "æœªæ£€æµ‹åˆ°æ‰‹éƒ¨";
                gestureStatus.style.color = "#ccc";
            }
            canvasCtx.restore();
        }

        function updateControl(isFist, isOpen, x, y) {
            // æ§åˆ¶é€»è¾‘
            // x: 0(å·¦) - 1(å³) [é•œåƒå]
            const rotateSpeed = 0.03;
            const deadZone = 0.35; // ä¸­å¿ƒæ­»åŒºèŒƒå›´ 0.35 - 0.65

            let actionText = "";
            let color = "#fff";

            // 1. æ—‹è½¬æ§åˆ¶ (ä¼˜å…ˆçº§æœ€é«˜)
            if (x < deadZone) {
                controls.rotateLeft(-rotateSpeed);
                actionText = "è§†è§’å³è½¬ ğŸ‘‰"; color = "#00ffcc";
            } else if (x > (1 - deadZone)) {
                controls.rotateLeft(rotateSpeed);
                actionText = "è§†è§’å·¦è½¬ ğŸ‘ˆ"; color = "#00ffcc";
            } else if (y < deadZone) {
                controls.rotateUp(-rotateSpeed);
                actionText = "è§†è§’å‘ä¸Š ğŸ‘†"; color = "#00ffcc";
            } else if (y > (1 - deadZone)) {
                controls.rotateUp(rotateSpeed);
                actionText = "è§†è§’å‘ä¸‹ ğŸ‘‡"; color = "#00ffcc";
            } else {
                // 2. ç¼©æ”¾æ§åˆ¶ (åœ¨ä¸­å¿ƒåŒºåŸŸæ—¶)
                if (isFist) {
                    controls.dollyOut(1.03); // ç¼©å°/åé€€
                    actionText = "âœŠ åé€€/ç¼©å°"; color = "#ff4500";
                } else if (isOpen) {
                    controls.dollyIn(1.03); // æ”¾å¤§/å‰è¿›
                    actionText = "ğŸ–ï¸ å‰è¿›/æ”¾å¤§"; color = "#00ff00";
                } else {
                    actionText = "âœ‹ å¾…æœºä¸­..."; color = "#ccc";
                }
            }
            
            controls.update();
            gestureStatus.innerText = actionText;
            gestureStatus.style.color = color;
        }

        // æ‘„åƒå¤´å¼€å…³é€»è¾‘
        const camBtn = document.getElementById('camBtn');
        const cameraHud = document.getElementById('cameraHud');

        camBtn.onclick = async () => {
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                showError("å®‰å…¨è­¦å‘Šï¼šæ‘„åƒå¤´åŠŸèƒ½éœ€è¦ HTTPS æˆ– localhost ç¯å¢ƒã€‚<br>è¯·ä½¿ç”¨ Live Server è¿è¡Œæˆ–éƒ¨ç½²åˆ° HTTPS ç½‘ç«™ã€‚");
                return;
            }

            if (!cameraRunning) {
                initHands();
                cameraHud.style.display = 'block';
                gestureStatus.innerText = "å¯åŠ¨æ‘„åƒå¤´ä¸­...";
                
                try {
                    myCamera = new Camera(videoElement, {
                        onFrame: async () => {
                            if(myHands) await myHands.send({image: videoElement});
                        },
                        width: 320,
                        height: 240
                    });
                    await myCamera.start();
                    cameraRunning = true;
                    camBtn.innerText = "ğŸš« å…³é—­æ‰‹åŠ¿";
                    camBtn.classList.add('active');
                } catch (e) {
                    console.error(e);
                    showError("æ— æ³•å¯åŠ¨æ‘„åƒå¤´ï¼Œè¯·å…è®¸æµè§ˆå™¨è®¿é—®æƒé™ã€‚");
                    cameraHud.style.display = 'none';
                }
            } else {
                if(myCamera) await myCamera.stop();
                cameraHud.style.display = 'none';
                cameraRunning = false;
                camBtn.innerText = "ğŸ“· å¼€å¯æ‰‹åŠ¿æ§åˆ¶";
                camBtn.classList.remove('active');
                gestureStatus.innerText = "å·²å…³é—­";
            }
        };

        function showError(msg) {
            errorMsg.innerHTML = msg;
            errorMsg.style.display = 'block';
            setTimeout(() => errorMsg.style.display = 'none', 5000);
        }

        // --- 3. åŠ¨ç”»ä¸å¸¸è§„äº¤äº’ ---
        function animate() {
            requestAnimationFrame(animate);
            planetMeshes.forEach(obj => {
                obj.angle += obj.speed * 0.2;
                obj.mesh.position.x = Math.cos(obj.angle) * obj.distance;
                obj.mesh.position.z = Math.sin(obj.angle) * obj.distance;
                obj.mesh.rotation.y += 0.02;
            });
            controls.update(); // ç¡®ä¿æ‰‹åŠ¨æ§åˆ¶ç”Ÿæ•ˆ
            renderer.render(scene, camera);
        }
        animate();

        // å¯¼èˆªæ äº¤äº’
        const navBar = document.getElementById('navBar');
        planetData.forEach(p => {
            const icon = document.createElement('div');
            icon.className = 'nav-icon';
            // å¦‚æœå›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºåº•è‰²
            icon.style.backgroundColor = '#' + p.color.toString(16);
            icon.style.backgroundImage = `url(${p.texture})`;
            icon.onclick = () => updateInfo(p);
            navBar.appendChild(icon);
        });

        // ç‚¹å‡»æ˜Ÿçƒäº¤äº’
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        window.addEventListener('click', (e) => {
            if(e.target.closest('.info-panel') || e.target.closest('.camera-toggle')) return;
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(planetMeshes.map(p=>p.mesh));
            if(intersects.length > 0) {
                const found = planetMeshes.find(p => p.mesh === intersects[0].object || intersects[0].object.parent === p.mesh);
                if(found) updateInfo(found.data);
            }
        });

        const pName = document.getElementById('planetName');
        const pPhoto = document.getElementById('planetPhoto');
        const pDesc = document.getElementById('planetDesc');
        const speakBtn = document.getElementById('speakBtn');
        let synth = window.speechSynthesis, isSpeaking = false;

        // åˆå§‹åŒ–é»˜è®¤å¤ªé˜³å›¾
        pPhoto.src = "https://upload.wikimedia.org/wikipedia/commons/thumb/b/b4/The_Sun_by_the_Atmospheric_Imaging_Assembly_of_NASA%27s_Solar_Dynamics_Observatory_-_20100819.jpg/600px-The_Sun_by_the_Atmospheric_Imaging_Assembly_of_NASA%27s_Solar_Dynamics_Observatory_-_20100819.jpg";

        function updateInfo(d) {
            if(isSpeaking) stopSpeech();
            pName.innerText = d.name; pPhoto.src = d.photo; pDesc.innerText = d.desc;
            
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.nav-icon').forEach(icon => icon.classList.remove('active'));
            // ç®€å•åŒ¹é…ç´¢å¼•
            const idx = planetData.indexOf(d);
            if(idx !== -1) navBar.children[idx].classList.add('active');

            speakBtn.onclick = () => toggleSpeech(d.desc);
        }

        function toggleSpeech(txt) {
            if(isSpeaking) { stopSpeech(); } else {
                stopSpeech(); const u = new SpeechSynthesisUtterance(txt);
                u.lang = 'zh-CN'; u.rate = 0.95; 
                u.onend = () => {isSpeaking=false; speakBtn.innerText='ğŸ”Š å¬å¬ä»‹ç»'};
                synth.speak(u); isSpeaking=true; speakBtn.innerText='â¸ï¸ æš‚åœ';
            }
        }
        function stopSpeech() { synth.cancel(); isSpeaking=false; speakBtn.innerText='ğŸ”Š å¬å¬ä»‹ç»'; }
        
        window.onresize = () => { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); };
    </script>
</body>
</html>